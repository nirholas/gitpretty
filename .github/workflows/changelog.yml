# ðŸ“‹ Auto Changelog Generator
# Generates changelog on release

name: ðŸ“‹ Auto Changelog

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      since_tag:
        description: 'Generate changelog since tag'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“‹ Generate Changelog
        run: |
          SINCE="${{ github.event.inputs.since_tag }}"
          if [ -z "$SINCE" ]; then
            SINCE=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          fi
          
          echo "# ðŸ“‹ Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "_Generated on $(date +%Y-%m-%d)_" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          if [ -n "$SINCE" ]; then
            echo "## Changes since $SINCE" >> CHANGELOG.md
            RANGE="${SINCE}..HEAD"
          else
            echo "## All Changes" >> CHANGELOG.md
            RANGE="HEAD"
          fi
          echo "" >> CHANGELOG.md
          
          # Group by emoji type
          echo "### âœ¨ Features" >> CHANGELOG.md
          git log $RANGE --oneline --grep="^âœ¨" --format="- %s (\`%h\`)" >> CHANGELOG.md 2>/dev/null || true
          echo "" >> CHANGELOG.md
          
          echo "### ðŸ› Bug Fixes" >> CHANGELOG.md
          git log $RANGE --oneline --grep="^ðŸ›" --format="- %s (\`%h\`)" >> CHANGELOG.md 2>/dev/null || true
          echo "" >> CHANGELOG.md
          
          echo "### ðŸ“ Documentation" >> CHANGELOG.md
          git log $RANGE --oneline --grep="^ðŸ“" --format="- %s (\`%h\`)" >> CHANGELOG.md 2>/dev/null || true
          echo "" >> CHANGELOG.md
          
          echo "### ðŸ”§ Configuration" >> CHANGELOG.md
          git log $RANGE --oneline --grep="^ðŸ”§" --format="- %s (\`%h\`)" >> CHANGELOG.md 2>/dev/null || true
          echo "" >> CHANGELOG.md
          
          echo "### ðŸ“¦ Other" >> CHANGELOG.md
          git log $RANGE --oneline --format="- %s (\`%h\`)" | head -20 >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          echo "---" >> CHANGELOG.md
          echo "_Generated by [gitpretty](https://github.com/nirholas/gitpretty)_" >> CHANGELOG.md

      - name: ðŸ“¤ Commit Changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "ðŸ“‹ Update changelog" || echo "No changes"
          git push || echo "Nothing to push"
